/**
 * Email Notifier - Gmail integration for notifications
 * Sends approval requests and daily summaries
 */

import nodemailer from 'nodemailer';

export class EmailNotifier {
    constructor(config = {}) {
        this.recipientEmail = config.recipientEmail || 'landon.king@luxebuildmedia.com';
        this.senderEmail = config.senderEmail || config.gmailUser;
        this.gmailUser = config.gmailUser;
        this.gmailPassword = config.gmailPassword;
        this.transporter = null;
    }

    /**
     * Initialize the mail transporter
     */
    async init() {
        if (!this.gmailUser || !this.gmailPassword) {
            console.warn('Gmail credentials not configured. Email notifications disabled.');
            return false;
        }

        this.transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                user: this.gmailUser,
                pass: this.gmailPassword
            }
        });

        try {
            await this.transporter.verify();
            console.log('Email notifier connected successfully');
            return true;
        } catch (error) {
            console.error('Email notifier connection failed:', error.message);
            return false;
        }
    }

    /**
     * Send an email
     */
    async send(subject, htmlBody, textBody = null) {
        if (!this.transporter) {
            console.log('Email would be sent (notifier not initialized):');
            console.log(`  To: ${this.recipientEmail}`);
            console.log(`  Subject: ${subject}`);
            console.log(`  Body: ${textBody || htmlBody}`);
            return { success: false, reason: 'notifier_not_initialized' };
        }

        try {
            const result = await this.transporter.sendMail({
                from: `"King AI Studio" <${this.senderEmail}>`,
                to: this.recipientEmail,
                subject,
                text: textBody || htmlBody.replace(/<[^>]*>/g, ''),
                html: htmlBody
            });

            console.log(`Email sent: ${subject}`);
            return { success: true, messageId: result.messageId };
        } catch (error) {
            console.error('Failed to send email:', error.message);
            return { success: false, error: error.message };
        }
    }

    /**
     * Send approval request email
     */
    async sendApprovalRequest(task, evaluation) {
        const subject = `üîî Approval Required: ${task.name}`;

        const html = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #e67e22;">üîî Approval Required</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
          <tr>
            <td style="padding: 10px; background: #f8f9fa; font-weight: bold; width: 100px;">Task:</td>
            <td style="padding: 10px; background: #f8f9fa;">${task.name}</td>
          </tr>
          <tr>
            <td style="padding: 10px; font-weight: bold;">Category:</td>
            <td style="padding: 10px;">${task.category}</td>
          </tr>
        </table>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
          <strong>What:</strong><br>
          ${task.description}
        </div>
        
        <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0;">
          <strong>Why:</strong><br>
          ${task.reasoning || 'Standard operation based on system analysis'}
        </div>
        
        <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin: 20px 0;">
          <strong>Reason for Approval:</strong><br>
          ${evaluation.reason}
        </div>
        
        <hr style="margin: 30px 0;">
        
        <div style="background: #28a745; color: white; padding: 20px; border-radius: 5px; text-align: center;">
          <strong style="font-size: 18px;">Is it OK to implement this?</strong><br><br>
          Reply: <strong>YES</strong> / <strong>NO</strong> / [Ask a question for more info]
        </div>
        
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Task ID: ${task.id}<br>
          Generated by King AI Studio
        </p>
      </div>
    `;

        return this.send(subject, html);
    }

    /**
     * Send daily summary email
     */
    async sendDailySummary(summary, questions = [], propositions = []) {
        const subject = `üìä Daily Summary - ${summary.date}`;

        const questionsHtml = questions.length > 0
            ? questions.map((q, i) => `<li>${q}</li>`).join('')
            : '<li>No questions for today</li>';

        const propsHtml = propositions.length > 0
            ? propositions.map(p => `
          <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <strong>${p.name}</strong><br>
            ${p.description}<br>
            <em style="color: #666;">Reply YES to pre-approve</em>
          </div>
        `).join('')
            : '<p>No pre-approval propositions for tomorrow</p>';

        const html = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2 style="color: #2c3e50;">üìä Daily Summary</h2>
        <p style="color: #666;">${summary.date}</p>
        
        <div style="display: flex; gap: 10px; margin: 20px 0;">
          <div style="flex: 1; background: #28a745; color: white; padding: 20px; border-radius: 5px; text-align: center;">
            <div style="font-size: 32px; font-weight: bold;">${summary.completed}</div>
            <div>Completed</div>
          </div>
          <div style="flex: 1; background: #dc3545; color: white; padding: 20px; border-radius: 5px; text-align: center;">
            <div style="font-size: 32px; font-weight: bold;">${summary.failed}</div>
            <div>Failed</div>
          </div>
          <div style="flex: 1; background: #ffc107; color: black; padding: 20px; border-radius: 5px; text-align: center;">
            <div style="font-size: 32px; font-weight: bold;">${summary.pendingApprovals.length}</div>
            <div>Pending</div>
          </div>
        </div>
        
        <h3 style="color: #2c3e50; margin-top: 30px;">üìù Recent Actions</h3>
        <table style="width: 100%; border-collapse: collapse;">
          ${summary.recentActions.map(a => `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px; color: #666; font-size: 12px;">${new Date(a.timestamp).toLocaleTimeString()}</td>
              <td style="padding: 8px;">${a.type}</td>
              <td style="padding: 8px;">${a.description}</td>
            </tr>
          `).join('')}
        </table>
        
        <h3 style="color: #2c3e50; margin-top: 30px;">‚ùì Questions for Tomorrow</h3>
        <ul>${questionsHtml}</ul>
        
        <h3 style="color: #2c3e50; margin-top: 30px;">üöÄ Pre-Approval Propositions</h3>
        ${propsHtml}
        
        <hr style="margin: 30px 0;">
        
        <p style="color: #666; font-size: 12px;">
          Generated by King AI Studio at ${new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' })} Chicago Time
        </p>
      </div>
    `;

        return this.send(subject, html);
    }

    /**
     * Send a simple notification
     */
    async sendNotification(title, message) {
        const subject = `‚ÑπÔ∏è ${title}`;
        const html = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>${title}</h2>
        <p>${message}</p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
          Generated by King AI Studio
        </p>
      </div>
    `;

        return this.send(subject, html);
    }
}

export default EmailNotifier;
